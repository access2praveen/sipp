<?xml version='1.0' encoding='ISO-8859-1'?>
<scenario name="SIPP scenario genertated by sipp_xml_generated">

<nop display="INVITE (client) connection:" />
<nop>
  <action>
    <assignstr assign_to="sdp_v" value="v=0" />
    <assignstr assign_to="sdp_o" value="o=user1 53655765 2353687637 IN IP[local_ip_type] [local_ip]" />
    <assignstr assign_to="sdp_s" value="s=-" />
    <assignstr assign_to="sdp_c" value="c=IN IP[media_ip_type] [media_ip]" />
    <assignstr assign_to="sdp_t" value="t=0 0" />
    <!-- G7221 32k bitrate-->
    <assignstr assign_to="sdp_m" value="[$sdp_m] 97" />
    <assignstr assign_to="sdp_a_g7221_32kbps" value="a=rtpmap:97 G7221/16000\na=fmtp:97 bitrate=32000" />
    <assignstr assign_to="sdp_a" value="[$sdp_a]\n[$sdp_a_g7221_32kbps]" />    
    <!-- PCMU -->
    <assignstr assign_to="sdp_m" value="[$sdp_m] 0" />
    <assignstr assign_to="sdp_a_pcmu" value="a=rtpmap:0 PCMU/8000" />
    <assignstr assign_to="sdp_a" value="[$sdp_a]\n[$sdp_a_pcmu]" />
    <!-- PCMA -->
    <assignstr assign_to="sdp_m" value="[$sdp_m] 8" />
    <assignstr assign_to="sdp_a_pcma" value="a=rtpmap:8 PCMA/8000" />
    <assignstr assign_to="sdp_a" value="[$sdp_a]\n[$sdp_a_pcma]" />
    <!-- G722 -->
    <assignstr assign_to="sdp_m" value="[$sdp_m] 9" />
    <assignstr assign_to="sdp_a_g722" value="a=rtpmap:9 G722/8000" />
    <assignstr assign_to="sdp_a" value="[$sdp_a]\n[$sdp_a_g722]" />

    <!-- G7221 24k bitrate-->
    <assignstr assign_to="sdp_m" value="[$sdp_m] 99" />
    <assignstr assign_to="sdp_a_g7221_24kbps" value="a=rtpmap:99 G7221/16000\na=fmtp:99 bitrate=24000" />
    <assignstr assign_to="sdp_a" value="[$sdp_a]\n[$sdp_a_g7221_24kbps]" />
    <!-- G7221C 32k bitrate-->
    <assignstr assign_to="sdp_m" value="[$sdp_m] 98" />
    <assignstr assign_to="sdp_a_g7221c_32kbps" value="a=rtpmap:98 G7221/32000\na=fmtp:98 bitrate=32000" />
    <assignstr assign_to="sdp_a" value="[$sdp_a]\n[$sdp_a_g7221c_32kbps]" />
    <!-- G7221C 48k bitrate-->
    <assignstr assign_to="sdp_m" value="[$sdp_m] 100" />
    <assignstr assign_to="sdp_a_g7221c_48kbps" value="a=rtpmap:100 G7221/32000\na=fmtp:100 bitrate=48000" />
    <assignstr assign_to="sdp_a" value="[$sdp_a]\n[$sdp_a_g7221c_48kbps]" />

    <assignstr assign_to="sdp" value="[$sdp_v]" />
    <assignstr assign_to="sdp" value="[$sdp]\n[$sdp_o]" />
    <assignstr assign_to="sdp" value="[$sdp]\n[$sdp_c]" />
    <assignstr assign_to="sdp" value="[$sdp]\n[$sdp_s]" />
    <assignstr assign_to="sdp" value="[$sdp]\n[$sdp_t]" />
    <assignstr assign_to="sdp" value="[$sdp]\nm=audio [media_port] RTP/AVP [$sdp_m]" />
    <assignstr assign_to="sdp" value="[$sdp]\n[$sdp_a]" />
    <assignstr assign_to="sdp_invite" value="[$sdp]" />
    <assignstr assign_to="sdp_ack" value="" />
  </action>
</nop>

  <send start_rtd="invite"><!-- Generated CDATA -->
    <![CDATA[
      INVITE sip:[service]@[remote_ip]:[remote_port] SIP/2.0
      Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
      From: sipp <sip:sipp@[local_ip]:[local_port]>;tag=[call_number]
      To: sut <sip:[service]@[remote_ip]:[remote_port]>
      Call-ID: [call_id]
      CSeq: [cseq] INVITE
      Contact: sip:sipp@[local_ip]:[local_port]
      Max-Forwards: 70
      X-DolbyVoice-Client-LogId: sipp_client_0
      X-DolbyVoice-MediaServer-MultiCodec: 1
      Subject: Performance Test
      Allow: INVITE, ACK, BYE, CANCEL, OPTIONS, PRACK, MESSAGE, SUBSCRIBE, NOTIFY, REFER, UPDATE, REGISTER, INFO
      Supported: 100rel
      Content-Type: application/sdp
      Content-Length: [len]

      [$sdp_invite]

    
  ]]>
<!-- End of Generated CDATA -->
</send>

  <recv optional="true" response="100">
  </recv>

  <recv optional="true" response="180">
  </recv>

  <recv response="200" rtd="invite">
    <action>
      <ereg assign_to="unused,client_sip_id" header="To:" regexp="tag=\s*(\S*)" search_in="hdr" />
      <ereg assign_to="unused,audio_port" regexp="m=audio (\S+) " search_in="body" />
      <!-- o=<username> <sess-id> <sess-version> <nettype> <addrtype> <unicast-address> -->
      <ereg assign_to="unused,audio_ip" regexp="o=\S+ \S+ \S+ \S+ \S+ (\S+)" search_in="body" />
    </action>
  </recv>

  <Reference variables="unused,client_sip_id" />
  <send crlf="true"><!-- Generated CDATA -->
    <![CDATA[
      ACK sip:[service]@[remote_ip]:[remote_port] SIP/2.0
      Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
      From: sipp <sip:sipp@[local_ip]:[local_port]>;tag=[call_number]
      To: sut <sip:[service]@[remote_ip]:[remote_port]>[peer_tag_param]
      Call-ID: [call_id]
      CSeq: [cseq] ACK
      Contact: sip:sipp@[local_ip]:[local_port]
      Max-Forwards: 70
      Subject: Performance Test
      Content-Type: application/sdp
      Content-Length: [len]

      [$sdp_ack]

    
  ]]>
<!-- End of Generated CDATA -->
</send>

<!--
<nop crlf="true" display="play multiple codec audio">
  <action>
    <log message="./PlayMultiCodec.sh [$audio_ip]/[$audio_port]"></log>
    <exec command="./PlayMultiCodec.sh [$audio_ip]/[$audio_port] &> log/all_codec.playrtpdump.log &"></exec>
  </action>
  </nop>
-->
<nop display="wait for 1000 msec:" />
  <pause crlf="true" milliseconds="1000" />

<nop display="create conf_1:" />
  <send><!-- Generated CDATA -->
       <![CDATA[
        INFO sip:[service]@[remote_ip]:[remote_port] SIP/2.0
        Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
        From: sipp <sip:sipp@[local_ip]:[local_port]>;tag=[call_number]
        To: sut <sip:[service]@[remote_ip]:[remote_port]>[peer_tag_param]
        Call-ID: [call_id]
        CSeq: [cseq] INFO
        Contact: sip:sipp@[local_ip]:[local_port]
        Accept: application/sdp, text/*, application/msml+xml, application/moml+xml
        Allow: INVITE, ACK, BYE, CANCEL, OPTIONS, PRACK, MESSAGE, SUBSCRIBE, NOTIFY, REFER, UPDATE, REGISTER, INFO
        Supported: 100rel
        Content-Type: application/msml+xml
        Content-Length: [len]

        <msml version="1.1">
          <createconference name="conf_1" deletewhen="nomedia">
            <audiomix>
              <asn ri="3s" />
              <n-loudest n="4" />
            </audiomix>
          </createconference>
        </msml>
       
  ]]>
<!-- End of Generated CDATA -->
</send>
  <recv crlf="true" response="200" />

<nop display="wait for 1000 msec:" />
  <pause crlf="true" milliseconds="1000" />

<nop display="join conf_1:" />
  <send><!-- Generated CDATA -->
       <![CDATA[
        INFO sip:[service]@[remote_ip]:[remote_port] SIP/2.0
        Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
        From: sipp <sip:sipp@[local_ip]:[local_port]>;tag=[call_number]
        To: sut <sip:[service]@[remote_ip]:[remote_port]>[peer_tag_param]
        Call-ID: [call_id]
        CSeq: [cseq] INFO
        Contact: sip:sipp@[local_ip]:[local_port]
        Accept: application/sdp, text/*, application/msml+xml, application/moml+xml
        Allow: INVITE, ACK, BYE, CANCEL, OPTIONS, PRACK, MESSAGE, SUBSCRIBE, NOTIFY, REFER, UPDATE, REGISTER, INFO
        Supported: 100rel
        Content-Type: application/msml+xml
        Content-Length: [len]

        <msml version="1.1">
          <join id1="conn:[$client_sip_id]" id2="conf:conf_1">
            <stream dir="to-id1" media="audio" dlb:echo_suppression="disable" dlb:audio_processing="enable" dlb:fec="disable" dlb:audio_processing_ver="1">
              <clamp dtmf="false" />
              <gain amt="0" />
            </stream>
            <stream dir="from-id1" media="audio" dlb:jb_min_latency="0ms">
              <clamp dtmf="true" />
              <gain amt="0" />
            </stream>
          </join>
        </msml>

       
  ]]>
<!-- End of Generated CDATA -->
</send>
  <recv crlf="true" response="200" />


<nop crlf="true" display="play multiple codec audio">
  <action>
    <log message="./PlayMultiCodec.sh [$audio_ip]/[$audio_port]"></log>
    <exec command="./PlayMultiCodec.sh [$audio_ip]/[$audio_port] &> log/all_codec.playrtpdump.log &"></exec>
  </action>
  </nop>


<nop display="wait for 1000 msec:" />
  <pause crlf="true" milliseconds="100000" />


<label id="ReInviteLoop" />
<nop display="wait for reInvite or INFO:" />

<nop>
  <action>
    <assign assign_to="reinvite_loop_max" value="10" />
    <assign assign_to="reinvite_loop_cnt" value="1" />
    <assign assign_to="reinvite_loop_increment" value="1" />
    <test assign_to="IsEndOfReinviteLoop" compare="greater_than" variable="reinvite_loop_cnt" variable2="reinvite_loop_max" />
  </action>
</nop>

<label id="reInvite_or_INFO" />

<nop next="EndOfReInviteLoop" test="IsEndOfReinviteLoop">
</nop>

<recv next="Send200" optional="true" request="INFO">
  <action>
    <ereg assign_to="unused,received_sip_msg" regexp="(.*)" search_in="msg" />
    <log message="received conf control leg SIP INFO: [$received_sip_msg]" />
  </action>
</recv>

<recv next="Send200Sdp" request="INVITE">
  <action>
    <log message="received conf control leg SIP reInv" />
  </action>
</recv>

<label id="Send200Sdp" />
<send><!-- Generated CDATA -->
  <![CDATA[
    SIP/2.0 200 OK
    [last_Via:]
    [last_From:]
    [last_To:]
    [last_Call-ID:]
    [last_CSeq:]
    Contact: <sip:[local_ip]:[local_port];transport=[transport]>
    Session-Expires: 90;refresher=uas
    Content-Type: application/sdp
    Content-Length: [len]

    [$sdp]

]]>
<!-- End of Generated CDATA -->
</send>

<recv next="reInvite_or_INFO" request="ACK">
  <action>
    <!-- set the loop cnt to end the whole session-->
    <add assign_to="reinvite_loop_cnt" variable="reinvite_loop_increment" />
    <test assign_to="IsEndOfReinviteLoop" compare="greater_than" variable="reinvite_loop_cnt" variable2="reinvite_loop_max" />
  </action>
</recv>


<label id="Send200" />
<send crlf="true" next="reInvite_or_INFO"><!-- Generated CDATA -->
  <![CDATA[

    SIP/2.0 200 OK
    [last_Via:]
    [last_From:]
    [last_To:]
    [last_Call-ID:]
    [last_CSeq:]
    Contact: <sip:[local_ip]:[local_port];transport=[transport]>
    Content-Type: application/msml+xml
    Content-Length: [len]

    <?xml version="1.0"?>
    <msml version="1.1">
      <result response="200" />
    </msml>

]]>
<!-- End of Generated CDATA -->
</send>

<label id="EndOfReInviteLoop" />
<nop>
  <action>
    <log message="ending session, send BYE"></log>
  </action>
</nop>

<nop display="send BYE" />
<send><!-- Generated CDATA -->
    <![CDATA[
      BYE sip:[service]@[remote_ip]:[remote_port] SIP/2.0
      Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
      From: sipp <sip:sipp@[local_ip]:[local_port]>;tag=[call_number]
      To: sut <sip:[service]@[remote_ip]:[remote_port]>[peer_tag_param]
      Call-ID: [call_id]
      CSeq: [cseq] BYE
      Contact: sip:sipp@[local_ip]:[local_port]
      Max-Forwards: 70
      Subject: Performance Test
      Content-Length: 0

    
]]>
<!-- End of Generated CDATA -->
</send>
<recv crlf="true" response="200" />

<label id="_unexp.retaddr"></label>
<nop crlf="true" display="stop multiple codec audio play">
  <action>
    <log message="stop multiple codec audio play"></log>
    <exec command="pkill -f PlayMultiCodec.sh.*[$audio_ip]/[$audio_port]"></exec>
    <exec command="pkill -f rtpplay.*[$audio_ip]/[$audio_port]"></exec>
  </action>
</nop>

</scenario>
